---
title: "Case Study"
author: "Trang Dinh"
date: "27 1 2021"
output:
  pdf_document: default
  html_document: default
---

# Library Packages
```{r}

library(readr)
library(dplyr) 
library("zoo")
library("forecast")
library("ggplot2")
library("mosaic")
library("Metrics")
library("dummies")
library("plotly")

```

# Datensatz laden
```{r}
shipment = read.csv2("shipment_FINAL_20210115.csv")
margin_week = read.csv2("margin_by_week_FINAL_20210115.csv")

head(shipment)
head(margin_week)

```

# Struktur der Datensätze
```{r}
cat("Struktur von shipments",str(shipment),"\n","\n")
cat("Struktur von margin_week",str(margin_week),"\n","\n")

```

# Summary der Datensätze
```{r}
cat("Zusammenfassung von shipment","\n",summary(shipment),"\n","\n")
cat("Zusammenfassung von margin_week","\n",summary(margin_week),"\n","\n")
```


# A) SHIPMENT 
Fehlende Werte
```{r}
inspect(shipment)

```

# Margin der vergangenen Shipments
```{r}
shipment$margin = shipment$total_revenue-shipment$total_cost

```

# Subset von not cancelled shipments
```{r}
shipment_without_cancellation = subset(shipment, shipment_state != "cancelled")
```

```{r}
#Hinzufügen einer Spalte `OTD` unter der Bedingung das die Lieferung pünktlich war

shipment_without_cancellation$OTD = ifelse(shipment_without_cancellation$last_stop_agreed_arrival_to >= shipment_without_cancellation$last_stop_actual_arrival, TRUE, FALSE)  
```


# Visualisierung Margin der vergangenen Shipments
```{r}
# Scatterplot
ggplot(shipment_without_cancellation , 
       aes(x = shipment_created_at, y = margin)) + 
  geom_point() +
  scale_color_manual(values = c("red"))

# Boxplot
ggplot(shipment_without_cancellation , 
       aes(x = "", y = margin)) + 
geom_boxplot()


```

```{r}
# Liniendiagramm

ggplot(shipment_without_cancellation, aes(x = shipment_created_at, y = margin,fill)) + 
        geom_line() 
```
Comment: 5 Peaks (positiv und negativ)

# Top 10 Margin
```{r}
head(shipment_without_cancellation[order(-shipment_without_cancellation$margin),],10) 
head(shipment_without_cancellation[order(shipment_without_cancellation$margin),],10) 
```

Auf die Korrelation untersuchen
** interne Faktoren:
business model: 3PL (3), 4PL(4) -> nominal
custom rate shipment: FALSCH(0), WAHR(1) -> nominal
fullfilment strategy: bulk(1),pallet (2), fullTruck(3) -> nominal
lane domain: national(1), international (2), import(3), export(4) -> nominal
stop count: 2,3,4,5,6,7 -> ordinal/kardinal
OTD: ontime (1), belated (0) ->nominal

**Probe**
```{r}
#business model
shipment_without_cancellation$business_model_code = ifelse(shipment_without_cancellation$business_model == "3PL", 3, 4) 

#custom rate shipment
shipment_without_cancellation$custom_rate_shipment_code = ifelse(shipment_without_cancellation$custom_rate_shipment == "FALSCH", 0, 1) 

#lane domain
shipment_without_cancellation$lane_domain_code =
  ifelse(
    shipment_without_cancellation$lane_domain == "national", 1, 
         ifelse(shipment_without_cancellation$lane_domain == "international",2,
                ifelse(shipment_without_cancellation$lane_domain == "import",3,4))
    )

#fullfilment strategy
shipment_without_cancellation$fulfilment_strategy_code =
  ifelse(
    shipment_without_cancellation$fulfilment_strategy == "bulk", 1, 
         ifelse(shipment_without_cancellation$fulfilment_strategy == "pallet",2,3)
         )
  
```

**Factor**
```{r}
# Convert to factor (binary variables)

shipment_without_cancellation$business_model <- as.factor(shipment_without_cancellation$business_model)


shipment_without_cancellation$custom_rate_shipment <- as.factor(shipment_without_cancellation$custom_rate_shipment)

```

```{r}
# Convert to factor (not binary variables)

fullfilment_strategy_dummies <- model.matrix(~fulfilment_strategy -1, data = shipment_without_cancellation)
head(fullfilment_strategy_dummies)


lane_domain_dummies <- model.matrix(~lane_domain -1, data = shipment_without_cancellation)
head(lane_domain_dummies)

lane_domain_dummies <- model.matrix(~lane_domain -1, data = shipment_without_cancellation)
head(lane_domain_dummies)


```

**Korrealtion**

Hier: Graphische Zusammefassung: 
a) business modell
```{r}
ggplot(shipment_without_cancellation, aes(x = business_model, y = margin())) +
  geom_boxplot() + 
  xlab("business model ") + ylab("margin (in Euro)")
```


Korrelationsplot erstellen
```{r}
# Laden des GGally Packages
library("GGally")
```

```{r}
# Correlation Plot erzeugen 
ggpairs(shipment_without_cancellation[, c("OTD", "custom_rate_shipment_code", "stops_count","margin")], 
        
        # ohne Visualisierung des Fortschritts der Erstellung des plots
        progress = FALSE,
        
        # mit Visualisierung einer Glaettungslinie und Aenderung der Farbe der Punkte, damit Linie erkennbar
        lower = list(continuous = wrap("smooth_loess", colour = "steelblue1"))) 
```

ggpairs(shipment_without_cancellation[, c("margin", "OTD", "custom_rate_shipment_code", "stops_count", "lane_domain", "fulfillment_strategy", "business_model")], 
        
        # ohne Visualisierung des Fortschritts der Erstellung des plots
        progress = FALSE,
        
        # mit Visualisierung einer Glaettungslinie und Aenderung der Farbe der Punkte, damit Linie erkennbar
        lower = list(continuous = wrap("smooth_loess", colour = "steelblue1"))) 

   
        
Für jede Veriable wird ein Regressionsmodel erstellt -> vergleich und auswählen
```{r}
model_business_model = lm(margin ~business_model, data = shipment_without_cancellation )
summary(model_business_model)

model_custom_rate_shipment = lm(margin ~custom_rate_shipment, data = shipment_without_cancellation )
summary(model_custom_rate_shipment)

model_fulfillment_strategy = lm(margin ~fulfilment_strategy, data = shipment_without_cancellation )
summary(model_fulfillment_strategy)

model_lane_domain = lm(margin ~lane_domain, data = shipment_without_cancellation )
summary(model_lane_domain)

model_stops_count = lm(margin ~stops_count, data = shipment_without_cancellation )
summary(model_stops_count)

model_OTD = lm(margin ~OTD, data = shipment_without_cancellation )
summary(model_OTD)


```


**Testbereich**

```{r}
cor(shipment_without_cancellation[, c("OTD", "custom_rate_shipment_code", "stops_count","margin")])
```

```{r}
# Regressionsmodell

model1 <- lm(margin ~ OTD+custom_rate_shipment+stops_count+lane_domain+fulfilment_strategy+business_model, data = shipment_without_cancellation)
summary(model1)

```
```{r}
# Regressionsmodell (ohne lane domain)

model2 <- lm(margin ~ OTD+custom_rate_shipment+stops_count+fulfilment_strategy+business_model, data = shipment_without_cancellation)
summary(model2)
```

```{r}
# Regressionsmodell (ohne stops count)

model3 <- lm(margin ~ OTD+custom_rate_shipment+lane_domain+fulfilment_strategy+business_model, data = shipment_without_cancellation)
summary(model3)
```


```{r}

# Regressionsmodell (ohne stops count, lane domain)

model4 <- lm(margin ~ OTD+custom_rate_shipment+fulfilment_strategy+business_model, data = shipment_without_cancellation)
summary(model4)

```

```{r}
# Regressionsmodell (ohne stops count, lane domain, fuulfillment strategy)

model5 <- lm(margin ~ OTD+custom_rate_shipment+business_model, data = shipment_without_cancellation)
summary(model5)

```


# B) MARGIN_WEEK

```{r}
inspect(margin_week)
```


Visualiasierung Data set: margin_week

Visualisierung des Anteils von cancelled_shipment_count_3pl 
```{r}
margin_week$cancelled_shipment_count_3pl_percentage = round( ((margin_week$shipment_count_3pl-margin_week$non_cancelled_shipment_count_3pl)/margin_week$shipment_count_3pl)*100,2) 

plot_ly(data = margin_week,x= ~first_stop_requested_arrival_to_week,   
        y= ~cancelled_shipment_count_3pl_percentage ,type = "bar")

```
comment: hoher Anteil von stonierten Shipments besonders zwischen Week 48-2019 und Week 02-2020 (Covid-19-Auswirkung), weitere Peaks am Ende des Jahres 2020 (second wave of coronavirus)

Visualisierung der Entwicklung von margin
```{r}
ggplot(data=margin_week, aes(x=first_stop_requested_arrival_to_week, y=forecasted_margin_3pl, group=1)) +
  geom_line()+
  geom_point()

# margin in percent!
```

```{r}
head(margin_week[order(margin_week$forecasted_margin_3pl),],5)
```
Comment: 
- tendenziell: sinkenede Gewinnmarge
- 5 kritische Zeitpunkte (negative perzentualle Gewinnmarge):
2019-52 (23.12.2019), 2020-01(30.12.2019-05.01.2020), 2020-36 bis 2020-38 (31.08.2020-20.09.2020)

Weekly Margin berechnen
```{r}
#margin in Euro aller 3PL-Shipments
margin_week$forecasted_margin_3pl_Euro = round( (margin_week$forecasted_revenue_3pl*(margin_week$forecasted_margin_3pl/100)),2)

#margin in Euro von 3PL custom_rate
margin_week$forecasted_margin_3pl_custom_rate_Euro = round( (margin_week$forecasted_revenue_3pl_custom_rate*(margin_week$forecasted_margin_3pl_custom_rate/100)),2)

#margin in Euro von 3PL spot
margin_week$forecasted_margin_3pl_spot_Euro = round( (margin_week$forecasted_revenue_3pl_spot*(margin_week$forecasted_margin_3pl_spot/100)),2)

#margin in Euro von 3PL spot FTL
margin_week$forecasted_margin_3pl_spot_ftl_Euro = round( (margin_week$forecasted_revenue_3pl_spot_ftl*(margin_week$forecasted_margin_3pl_spot_ftl/100)),2)

```

Visualisierung
```{r}
# Anteil der margins von custom_rate und spot an den gesamten 3PL margins
fig <- plot_ly(data = margin_week,x= ~first_stop_requested_arrival_to_week,   
        y= ~forecasted_margin_3pl_custom_rate_Euro,type = "bar", name ="custom_rate")
fig <- fig %>% add_trace(y= ~forecasted_margin_3pl_spot_Euro, name ="spot")
  
fig <- fig %>% layout(yaxis = list(title = 'margin'), barmode = 'stack')
fig

```

```{r}
plot_ly(data = margin_week,x= ~first_stop_requested_arrival_to_week,   
        y= ~forecasted_margin_3pl_custom_rate_Euro,type = "bar", name ="custom_rate") %>%  
  add_trace(y= ~forecasted_margin_3pl_spot_Euro, name ="spot")%>% 
  layout(yaxis = list(title = 'margin'), barmode = 'stack')


```

```{r}
# Anteil der margins von 3PL spot FTL spot an den  3PL spot margins
barplot(height = margin_week$forecasted_margin_3pl_spot_ftl,
        names=margin_week$first_stop_requested_arrival_to_week, 
        col="#69b3a2",
        ylim = c( -10 , 30 ),
        ylab="Prozentualler Anteil an 3PL spot",
        las = 2)
```
comment:
negative Anteile der Gewinnmarge aus 3PL spot FTL Transport in den Wochen: 
38,39,41,42 (Iahr 2018) und 02,05,06,07,10,11 (Jahr 2019)
Wertbereich: [-1,48;-7,88]

Exkurs: Vorteile von FTL
● Lieferung mit hoher Geschwindigkeit
● Verladung gelingt schneller, da keine Zusammenfassung von Teillieferungen erforderlich
● Keine Umwege auf dem Transportweg
● Keine Zwischenstopps
● Keine Umladungen
● Preisgünstige Lieferung
● Alle Waren gleichzeitig beim Kunden
● Beste Wahl für zeitkritische Lieferungen
