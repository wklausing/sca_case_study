---
title: "case_study"
author: "klauwi"
date: "2/3/2021"
output: html_document
---

install.packages("stringr")
Library Packages
```{r}
library(stringr)
library(tidyr)
library(readr)
library(dplyr) 
library("zoo")
library("forecast")
library("ggplot2")
library("Metrics")
library("dummies")
library("lubridate")
```

***Aufgabe A: Erkenntnisgewinn***
Ziel der Aufgabe ist der Bericht von etwaigen Erkenntnissen über die Daten, 
die Sie im Laufe der Projektbearbeitung erlangt haben. 
Zudem soll gezielt über die in der Fallstudienbeschreibung geforderten Punkte berichtet werden. 
Die Daten sollen angemessen aufbereitet und visualisiert werden. 
Wenn möglich sollen Handlungsempfehlungen aus den Erkenntnissen abgeleitet werden. 
Zu diesem Zweck können Sie beispielsweise folgendes nutzen:
• Visuelle Exploration
• Kennzahlen und Reporting:
  - von Verfahren identifizierte Muster (Saisonalitäten, Trends, ...)
  - Korrelationen
  - Verschiedene Methoden der deskriptiven Statistik (Clustering, ...)
Versuchen Sie einen möglichst guten Überblick über die Shipment-Daten zu generieren. 
Gehen Sie dabei schon gezielt auf die *Marge* ein (sowohl die *zeitliche Entwicklung* als auch identifizierte Zusammenhänge). Achten Sie bei Ihren Interpretationen auf die Gültigkeit von Aussagen über Kausalitäten.
Der Lösungsraum dieser Teilaufgabe geht ins Unermessliche. 
Beschränken Sie sich in Ihrer Präsentation daher auf eine Auswahl an Inhalten, die Ihnen besonders wichtig und präsentationswürdig erscheinen. Bereiten Sie gegebenenfalls ein Portfolio im Back-Up Ihrer Präsentation vor, um auf Anschlussfragen reagieren zu können. Sie sollten bei Ihrer Vorstellung dieser Teilaufgabe versuchen Zusammenhänge zu interpretieren und Implikationen abzuleiten, selbst wenn Ihre erarbeiteten Inhalte durch experimentelle Untersuchungen entstanden sind.


***(1) Datenvorbereitung***
### (1.1) CSV Dateien einlesen
```{r}
shipments <- read.csv("data/shipment_FINAL_20210115.csv")
margin <- read.csv("data/margin_by_week_FINAL_20210115.csv")

head(shipments)
head(margin)
```
### (1.2) Struktur ausgeben
```{r}
str(shipments)
str(margin)
```
```{r}
summary(shipments)
```
```{r}
# die Marge über die Monate nach business_model aggregieren
marge_YearMonth = aggregate(marge ~ first_stop_requested_arrival_to_YearMonth + business_model, shipments, sum )

# das businessmodell als Spalte etablieren
marge_YearMonth_reshaped= reshape(marge_YearMonth,
                         timevar="business_model",
                         idvar = c("first_stop_requested_arrival_to_YearMonth"),
                         direction = "wide")
marge_YearMonth_reshaped
```


*Cleaning Data*
# Shipment DataFrame
## Spalte country_lane aufspalten
```{r}
#Die Spalte `country_lane` wird in eine Spalte `origin_country` und eine Spalte ´destination_country´ aufgeteilt 
shipments <- shipments %>%
  separate(country_lane, c("origin_country","destination_country"), "-->>")
```

## Spalte ´Gewinn´ berechnen
```{r}
shipments = shipments %>%
  mutate(marge = total_revenue - total_cost)
```


## Spalte "last_stop_requested_arrival_to_date" als Jahr_Monat hinzufügen
```{r}
shipments <- shipments %>%
  mutate(first_stop_requested_arrival_to_date = ymd(first_stop_requested_arrival_to_date)) %>%
  mutate(first_stop_requested_arrival_to_YearMonth = format(first_stop_requested_arrival_to_date, "%Y-%m")) %>%
  mutate(CalenderWeek = format(first_stop_requested_arrival_to_date, "%Y-%V")) 

colnames(margin)[1]=c("CalenderWeek")
```

# margin DataFrame
## Calender Week einen Monat und ein Jahr zuordnen
```{r}
margin %>%
  mutate(CalenderWeek = yv(CalenderWeek)) %>%
  mutate(YearMonth = format(CalenderWeek, "%Y-%m"))
# Idee: Datumsangabe in Monate umwandeln um Saisonalitäten zu untersuchen
```

```{r}
ggplot(margin, aes(CalenderWeek, non_cancelled_shipment_count_3pl))+geom_point()
```


```{r}
countshipments <- shipments %>%
count(CalenderWeek)

ggplot(countshipments, aes(CalenderWeek, n))+geom_col()
```

***(3) Visuelle Exploration (mit Aggregation)***
```{r}
aggregate()
```


### (3.1) Shipments Gegenueberstellung: total_cost und total_revenue
```{r}
# Umsatz aggrerieren
df_Revenue = data.frame(aggregate(
  total_revenue ~ business_model + fulfilment_strategy, data=TableBind, sum))

# Kosten aggrerieren
df_Cost = data.frame(aggregate(
  total_cost ~ business_model + fulfilment_strategy, data=TableBind, sum))

# Beide DataFrames mergen
df_Compare = cbind(df_Revenue, df_Cost$total_cost)

# Umbenennen
colnames(df_Compare)[4] = "total_cost"
df_Compare

#TODO: Datenbereinigen mit unique() und ungleich null
#TODO: Grafik verbessern, da hier nicht Kosten und Umsaetze angezeigt werden
barplot(table(TableBind$fulfilment_strategy , TableBind$business_model ), 
        beside = TRUE, #horiz = TRUE,
        col=c("darkblue", "darkred"),
        xlab="Business Model", ylab="Anzahl", 
        main="titel")
```


### (3.2) Shipments Gegenuberstellung: Lieferungskosten gebucht und zugewiesen
```{r}
group1 = aggregate(transport_price_booked ~ 
                     fulfilment_strategy + business_model, data=shipments, sum)
group2 = aggregate(transport_cost_assigned  ~ 
                     fulfilment_strategy + business_model, data=shipments, sum)

differenz = group1[3] - group2[3]
colnames(differenz) = "differenz"

# Spalten von Dataframes werden verbunden
groupbind = cbind(group1, group2[3], differenz)
groupbind

#TODO: Datenbereinigen mit unique() und ungleich null
#TODO: Grafik von entstandene Kosten bei Lieferung waere gut
```

### (3.3) Shipments Gegenuberstellung: shipment_state + shipment_stage + business_model
```{r}

```

### (3.4) Margin: Vorhersage aus Margin visualisieren. 
# Vorhersage Daten existieren schon. Erst in Teil B neue Vorhersage machen.
```{r}

```




***(4) Kennzahlen und Reporting von Verfahren identifizierte Muster zB Saisonalitäten, Trends, ...***
```{r}

```


***(5) Korrelationen***
```{r}

```


***(6) Verschiedene Methoden der deskriptiven Statistik (Clustering, ...)***
```{r}

```

