---
title: "case_study"
author: "klauwi"
date: "2/3/2021"
output: html_document
---

Library Packages
```{r}
#rm(list = ls())
library("tidyverse")
library("forecast")
```

***Aufgabe A: Erkenntnisgewinn***
Ziel der Aufgabe ist der Bericht von etwaigen Erkenntnissen über die Daten, 
die Sie im Laufe der Projektbearbeitung erlangt haben. 
Zudem soll gezielt über die in der Fallstudienbeschreibung geforderten Punkte berichtet werden. 
Die Daten sollen angemessen aufbereitet und visualisiert werden. 
Wenn möglich sollen Handlungsempfehlungen aus den Erkenntnissen abgeleitet werden. 
Zu diesem Zweck können Sie beispielsweise folgendes nutzen:

• *Visuelle Exploration*
- Datenbereinigung #Wilke, erledigt
- Grafik Cost und Renvue #Wilke, erledigt
- Grafik zu (transport_price_booked + transport_cost_assigned) #Anny, erledigt
- Grafik zu Marge allein um Schwankungen zu identifizieren #Anny, erledigt

• Kennzahlen und Reporting:
  - *Identifikation von Muster (zB Saisonalitäten, Trends, ...)*
  - *Korrelationen* 
    > Interne Korrelation #Dinh
    > Externe Daten #Anny, Wilke, Toke
  - *Methoden der deskriptiven Statistik (Clustering, Times Series...)* #Toke
  
Versuchen Sie einen möglichst guten Überblick über die Shipment-Daten zu generieren. 
Gehen Sie dabei schon gezielt auf die *Marge* ein (sowohl die *zeitliche Entwicklung* als auch identifizierte Zusammenhänge). Achten Sie bei Ihren Interpretationen auf die Gültigkeit von Aussagen über Kausalitäten.
Der Lösungsraum dieser Teilaufgabe geht ins Unermessliche. 
Beschränken Sie sich in Ihrer Präsentation daher auf eine Auswahl an Inhalten, die Ihnen besonders wichtig und präsentationswürdig erscheinen. Bereiten Sie gegebenenfalls ein Portfolio im Back-Up Ihrer Präsentation vor, um auf Anschlussfragen reagieren zu können. Sie sollten bei Ihrer Vorstellung dieser Teilaufgabe versuchen Zusammenhänge zu interpretieren und Implikationen abzuleiten, selbst wenn Ihre erarbeiteten Inhalte durch experimentelle Untersuchungen entstanden sind.


***(1) Datenvorbereitung***
### (1.1) CSV Dateien einlesen 
```{r eval=FALSE}
# Shipments Daten einlesen und ins richtige Format bringen.
shipments <- read.csv("data/shipment_FINAL_20210115.csv")
# Timestamps
shipments$shipment_created_at = as.POSIXct(shipments$shipment_created_at,tz=Sys.timezone())

shipments[shipments$smh_accepted_first_state_change == "",]$smh_accepted_first_state_change = NA
shipments$smh_accepted_first_state_change = as.POSIXct(shipments$smh_accepted_first_state_change,tz=Sys.timezone())  

shipments[shipments$smh_accepted_last_state_change == "",]$smh_accepted_last_state_change = NA
shipments$smh_accepted_last_state_change = as.POSIXct(shipments$smh_accepted_last_state_change,tz=Sys.timezone())  

shipments$first_stop_requested_arrival_to = as.POSIXct(shipments$first_stop_requested_arrival_to,tz=Sys.timezone())  

shipments$first_stop_agreed_arrival_to = as.POSIXct(shipments$first_stop_agreed_arrival_to,tz=Sys.timezone())

shipments[shipments$last_stop_agreed_arrival_to == "",]$last_stop_agreed_arrival_to = NA
shipments$last_stop_agreed_arrival_to = as.POSIXct(shipments$last_stop_agreed_arrival_to,tz=Sys.timezone())

shipments[shipments$first_stop_actual_arrival == "",]$first_stop_actual_arrival = NA
shipments$first_stop_actual_arrival = as.POSIXct(shipments[shipments$first_stop_actual_arrival != "",]$first_stop_actual_arrival,tz=Sys.timezone())

shipments[shipments$last_stop_requested_arrival_to == "",]$last_stop_requested_arrival_to = NA
shipments$last_stop_requested_arrival_to = as.POSIXct(shipments$last_stop_requested_arrival_to,tz=Sys.timezone())

shipments[shipments$last_stop_actual_arrival == "",]$last_stop_actual_arrival = NA
shipments$last_stop_actual_arrival = as.POSIXct(shipments[shipments$last_stop_actual_arrival != "",]$last_stop_actual_arrival,tz=Sys.timezone())

shipments[shipments$sh_cancelled == "",]$sh_cancelled = NA
shipments$sh_cancelled = as.POSIXct(shipments[shipments$sh_cancelled != "",]$sh_cancelled,tz=Sys.timezone())

# Dates
shipments$first_stop_requested_arrival_to_date = shipments$first_stop_requested_arrival_to_date %>% as.Date()
shipments$last_stop_requested_arrival_to_date = shipments$last_stop_requested_arrival_to_date %>% as.Date()

# Erzeuge total_margin Spalte. (total_margin = total_revenue - total_cost)
shipments$total_margin = shipments$total_revenue - shipments$total_cost

# Erzeuge Spalte für Jahr. Monat, Tag
shipments = shipments %>%
  dplyr::mutate(year = lubridate::year(first_stop_agreed_arrival_to), 
                month = lubridate::month(first_stop_agreed_arrival_to), 
                day = lubridate::day(first_stop_agreed_arrival_to))

# Jahr-Monat Spalte
shipments$YearMonth = shipments$first_stop_agreed_arrival_to %>% as.Date() %>% strftime(., format = "%Y-%m") 


# Margin Daten einlesen 
margin <- read.csv2("data/margin_by_week_FINAL_20210115.csv")
```


### (1.2) Datenbereinigung
```{r eval=FALSE}
# Shipments Datenbereinigung
#1. Entferne Zeilen mit leerer lane_domain. Betrifft 2 Zeilen.  
shipments = shipments[shipments$lane_domain != "",]

#2. Entferne Zeilen mit cancellation_reason = fake_order. Betrifft 1622 Zeilen.
shipments = shipments[shipments$cancellation_reason != "fake_order",]

#3. Ändere 2024 zu 2020 in last_stop_requested_arrival_to und last_stop_requested_arrival_to_date Spalte. Betrifft 1 Zeile.
shipments[shipments$last_stop_requested_arrival_to == "2024-11-20 07:00:00",]$last_stop_requested_arrival_to = "2020-11-20 07:00:00"
shipments[shipments$last_stop_requested_arrival_to_date == "2024-11-20",]$last_stop_requested_arrival_to_date = "2020-11-20"

#4. Ändere 0019 zu 2019. Betrifft 1 Zeile.
shipments[!is.na(shipments$first_stop_actual_arrival) & shipments$first_stop_actual_arrival == "0019-08-20 01:53:28",]$first_stop_actual_arrival = as.POSIXct("2019-08-20 01:53:28",tz=Sys.timezone())

#5. Prüfen auf Duplikate insgesamt und für shipment_reference speziell. Betrifft 0 Zeilen.
#shipments = shipments %>%  distinct(.)
#shipments <- shipments[!duplicated(shipments$shipment_reference),]

#6. Entferne ersten 4 Zeilen, siehe Forum. Betrifft 4 Zeilen.
shipments = shipments[-1:-4,]

#7. Entferne weitere Zeile, da es nur 1 Tag vom ganzen Monat ist. Betrifft 1 Zeile.
shipments = shipments[-1,]

#8. Entferne Zeile mit -1 in transport_cost_assigned, da dies laut Dokumentation nicht sein kann. Selbes für transport_price_booked. Betrifft 1 Zeile.
shipments = shipments[shipments$transport_price_booked >= 0 & shipments$transport_cost_assigned >= 0,]

#9. Ausreißer bei total_revenue und total_cost entfernen.
ggplot(data = shipments, aes(x=total_revenue, y=total_cost))+
  geom_point()+
  theme_classic()+
  labs(
    x="Gesamt Umsatz",
    y="Gesamt Kosten",
    title = "Ausreißer Erkennen Kosten vs. Umsatz"
  ) #+ theme1 # Vorher
# Bereinigung der erkannten Ausreißer
shipments = shipments[shipments$total_revenue < 5000 & shipments$total_revenue > -1000 & shipments$total_cost > -1000,]

ggplot(data = shipments, aes(x=total_revenue, y=total_cost))+
  geom_point()+
  theme_classic()+
  labs(
    x="Gesamt Umsatz",
    y="Gesamt Kosten",
    title = "Ausreißer Erkennen Kosten vs. Umsatz"
  )# + theme1 # Nachher

#10. transport_cost_assigned und transport_price_booked dürfen nur größer/gleich 0 sein. 
shipments = shipments[shipments$transport_cost_assigned >= 0 & shipments$transport_price_booked >= 0,]

#11. Entferne Zeilen die nur NA haben.
shipments = shipments[!is.na(shipments$shipment_reference), ]

#12. Die Spalte `country_lane` wird in eine Spalte `origin_country` und eine Spalte ´destination_country´ aufgeteilt 
shipments <- shipments %>%
  separate(country_lane, c("origin_country","destination_country"), "-->>")

#TODO OTD noch berechnen
#Hinzufügen einer Spalte `OTD` unter der Bedingung das die Lieferung pünktlich war
shipments$OTD = ifelse(shipments$last_stop_agreed_arrival_to >= shipments$last_stop_actual_arrival, TRUE, FALSE)

# Dataframes abspeichern
saveRDS(shipments, "data/shipments.rds")
saveRDS(margin, "data/margins.rds")
```
***Vorbereiteten Daten aus RDS Dateien einlesen***
```{r eval=TRUE}
shipments = readRDS(file = "data/shipments.rds")
margin = readRDS(file = "data/margins.rds")
```

### (1.2) Struktur ausgeben
```{r eval=TRUE}
head(shipments)
str(shipments)

head(margin)
str(margin)
```

***Daten Formatieren: Zeitliche Entwicklung***
### (1.3) JAHR-MONAT extrahieren
```{r eval=FALSE}
# Extrahieren von Jahr-Monat aus Shipment-Spalte "last_stop_requested_arrival_to_date", 
# da diese Spalte auch in Margin-Spalte vorhanden ist
x <- as.Date(TableBind$last_stop_requested_arrival_to_date, format="%Y-%m-%d")

# Jahr-Monat an die Shipment Spalte hinten anhaengen
TableBind$YearMonth = format(x,"%Y-%m")

#Info: Benoetigen wir spaeter fuer die Zeitreihenanalyse und Vorhersage
```


***(2) Visuelle Exploration (mit Aggregation)***
### (2.1) Shipments Gegenueberstellung: total_cost und total_revenue
```{r eval=FALSE}
# Umsatz aggrerieren
df_Revenue = data.frame(aggregate(
  total_revenue ~ business_model + fulfilment_strategy, data=TableBind, sum))

# Kosten aggrerieren
df_Cost = data.frame(aggregate(
  total_cost ~ business_model + fulfilment_strategy, data=TableBind, sum))

# Beide DataFrames mergen
df_Compare = cbind(df_Revenue, df_Cost$total_cost)

# Umbenennen
colnames(df_Compare)[4] = "total_cost"
df_Compare
```

### (2.2) Zwei Liniendiagramme zu Shipment Kosten, Umsatz und Marge
```{r eval=TRUE}
# Verkettung der zwei Tabellen: Shipments + Mergin
# Datum von Shipment Spalte "last_stop_requested_arrival_to_date" so umformatieren, dass Kalenderwoche angezeigt wird
YearMonthFormat = as.Date(shipments$shipment_created_at)
shipments$YearMonth = strftime(YearMonthFormat, format = "%Y-%m") #Jahr-Monat

# Revenue und Costdarstellen
shipments_week_aggregated = shipments[c("YearMonth", "total_revenue", "total_cost")] %>% 
  aggregate(. ~ YearMonth, data = ., sum)
shipments_week_aggregated$margin = 
  shipments_week_aggregated$total_revenue - shipments_week_aggregated$total_cost
shipments_week_aggregated 

# Liniendiagram von Kosten, Umsatz und Marge
ggplot(data = shipments_week_aggregated, aes(x = YearMonth, group=1)) + 
  geom_line(aes(y = total_cost), colour="red") + 
  geom_line(aes(y = total_revenue), colour="darkgreen") +
  geom_line(aes(y = margin), colour="black") + 
  xlab("Date") +  
  ylab("Euro") +
  ggtitle(label = "Instafreight: Umsatz, Kosten und Marge (2017-2021)") +
  theme(axis.text.x = element_text(angle=45, vjust = 1.1, hjust=1.2, size=8)) + 
    #y-Achse Zahlen als Integer-Wert deklarieren
    scale_y_continuous(labels = scales::number_format(accuracy = 100)) +
    scale_x_discrete(breaks = shipments_week_aggregated$YearMonth[seq(1, length(shipments_week_aggregated$YearMonth), by = 2)]) 


# Zweites Liniendiagram nur mit Marge
ggplot(data = shipments_week_aggregated, aes(x = YearMonth, group=1)) +
  geom_line(aes(y = margin), colour="black") + 
  xlab("Date") +  
  ylab("Euro") +
  ggtitle(label = "Instafreight: Marge (2017-2021)") +
  theme(axis.text.x = element_text(angle=45, vjust = 1.1, hjust=1.2, size=8)) + 
    #y-Achse Zahlen als Integer-Wert deklarieren
    scale_y_continuous(breaks = function(x) unique(floor(pretty(seq(0, (max(x) + 1) * 1.1))))) +
    # Periode in 6 Jahrsabstaenden wiedergeben
    scale_x_discrete(breaks = shipments_week_aggregated$YearMonth[seq(1, length(shipments_week_aggregated$YearMonth), by = 2)])

#TODO Y besser darstellen
#TODO Legende fehlt
```

### (2.3) Ein Liniendiagramm zu Shipment transport_price_booked + transport_cost_assigned
```{r eval=TRUE}
# Aggregieren
shipments_week_aggregated = shipments[c("YearMonth", "transport_price_booked", "transport_cost_assigned")] %>% 
  aggregate(. ~ YearMonth, data = ., sum)
shipments_week_aggregated$difference = 
  shipments_week_aggregated$transport_price_booked - shipments_week_aggregated$transport_cost_assigned
shipments_week_aggregated 


# Liniendiagramm Uebersicht
ggplot(data = shipments_week_aggregated, aes(x = YearMonth, group=1)) + 
  geom_line(aes(y = transport_price_booked), colour="red") + 
  geom_line(aes(y = transport_cost_assigned), colour="blue") +
  geom_line(aes(y = difference), colour="black") + 
  xlab("Date") +  
  ylab("Euro") +
  ggtitle(label = "Instafreight: Buchungspreis, Transportkosten und Differenz (2017-2021)") +
  theme(axis.text.x = element_text(angle=45, vjust = 1.1, hjust=1.2, size=8)) + 
  #y-Achse Zahlen als Integer-Wert deklarieren
  scale_y_continuous(labels = scales::number_format(accuracy = 100)) +
  scale_x_discrete(breaks = shipments_week_aggregated$YearMonth[seq(1, length(shipments_week_aggregated$YearMonth), by = 2)])

```


### (2.4) 
```{r eval=TRUE}
# Revenue und Costdarstellen
shipments_week_aggregated = shipments[c("shipment_created_at", "total_revenue", "total_cost")] %>% aggregate(. ~ shipment_created_at, data = ., sum)
shipments_week_aggregated$profit = shipments_week_aggregated$total_revenue - shipments_week_aggregated$total_cost

ggplot(data = shipments_week_aggregated, aes(x = shipment_created_at, group=1)) + 
  geom_line(aes(y = total_cost), colour="red") + 
  geom_line(aes(y = total_revenue), colour="blue") +
  geom_line(aes(y = profit), colour="black") + 
  xlab("Date") +  
  ylab("Euro") +
  ggtitle(label = "Instafreight: Revenue, Cost, and Profit group by shipment_created_at") +
  theme(axis.text.x = element_text(angle=45, vjust = 1.1, hjust=1.2, size=8)) +
  scale_y_continuous(breaks=NULL)

#TODO X Achse zu Monaten umwandeln
#TODO Ausreisser bereinigen.
```

```{r eval=TRUE}
# Revenue und Costdarstellen
shipments_week_aggregated = shipments[c("shipment_created_at", "total_revenue", "total_cost")] %>% aggregate(. ~ shipment_created_at, data = ., sum)
shipments_week_aggregated$profit = shipments_week_aggregated$total_revenue - shipments_week_aggregated$total_cost

ggplot(data = shipments_week_aggregated, aes(x = shipment_created_at, group=1)) + 
  geom_line(aes(y = total_cost), colour="red") + 
  geom_line(aes(y = total_revenue), colour="blue") +
  geom_line(aes(y = profit), colour="black") + 
  xlab("Date") +  
  ylab("Euro") +
  ggtitle(label = "Instafreight: Revenue, Cost, and Profit group by shipment_created_at") +
  theme(axis.text.x = element_text(angle=45, vjust = 1.1, hjust=1.2, size=8)) +
  scale_y_continuous(breaks=NULL)

#TODO X Achse zu Monaten umwandeln
#TODO Ausreisser bereinigen.
```

### (2.5) Shipments Gegenuberstellung: Lieferungskosten gebucht und zugewiesen
```{r eval=TRUE}
group1 = aggregate(transport_price_booked ~ 
                     fulfilment_strategy + business_model, data=shipments, sum)
group2 = aggregate(transport_cost_assigned  ~ 
                     fulfilment_strategy + business_model, data=shipments, sum)

differenz = group1[3] - group2[3]
colnames(differenz) = "differenz"

# Spalten von Dataframes werden verbunden
groupbind = cbind(group1, group2[3], differenz)
groupbind

#TODO: Datenbereinigen mit unique() und ungleich null
#TODO: Grafik von entstandene Kosten bei Lieferung waere gut
```

```{r eval = false}
# Shipments: Prüfen ob Ausprägungen mit der Dokumentation übereinstimmen.
shipments$shipment_state %>% unique(.)
shipments$shipment_stage %>% unique(.)
shipments$business_model %>% unique(.)
shipments$custom_rate_shipment %>% unique(.)
shipments$lane_domain %>% unique(.)
shipments$country_lane %>% unique(.)
shipments$stops_count %>% unique(.)
shipments$cancellation_reason %>% unique(.)

```

```{r}
# Shipments: Balkendiagram für cancellation_reason
total_shipments = shipments %>% nrow()
total_cancelled_shipments = shipments[shipments$cancellation_reason != "",] %>% nrow()

success_rate = 1 - total_cancelled_shipments / total_shipments
success_rate
# 92.75% aller shipments sind erfolgreich, 7.25% nicht.
```

```{r eval = false}
# Shipments: Balkendiagram für cancellation_reason
shipments[shipments$cancellation_reason != "",]$cancellation_reason %>% table(.) %>%  barplot(., names=unique(shipments[shipments$cancellation_reason != "",]$cancellation_reason), las=2, cex.names=.6)

# TODO: Untersuchung in September 2020 die Cancellation Zahlen mit den Umsaetzen sowie Grund
# Erkenntnis: Spediteur nicht gefunden ist relativ hoch


shipments[shipments$cancellation_reason != "",] %>% aggregate(cancellation_reason ~ YearMonth, ., length)

```

```{r eval = false}
# Shipments: Vergleich von Plot 
shipments_customer_not_ready = shipments[shipments$cancellation_reason == "customer_not_ready",]

plot(x=shipments_customer_not_ready$total_revenue, y=shipments_customer_not_ready$total_cost)

#Bei 220 und 320 Revenue scheinen vllt Fixkosten für Kunden zu sein wen diese absagen, da sich an diesen Stellen Linien bilden.
```

```{r eval = false}
#TODO Shipments: total_cost = 1 und total_revenue = 1. Aussortieren? Betrifft 276 Zeilen
weird_shipments = shipments[shipments$total_cost == 1 & shipments$total_revenue == 1,]
weird_shipments
```

```{r eval = false}
#Auffälligkeiten bei Preisen und Kosten suchen. Am besten einfach mit Table und nach Häufigkeit sortieren.
shipments$transport_cost_assigned %>% table(.) %>%  barplot(.)
shipments$total_cost %>% table(.) %>%  barplot(.)

shipments$transport_price_booked %>% table(.) %>%  barplot(.)
shipments$total_revenue %>% table(.) %>%  barplot(.)
```


```{r eval = false}
#
#Wachstum für Monate.
growth_by_month = shipments %>% aggregate(total_revenue ~ year+month , data = ., sum)
growth_by_month = growth_by_month[order(growth_by_month$year, growth_by_month$month ),]

for(i in 1:nrow(growth_by_month)) {
  if(i == 1) {
    growth_by_month$monthly_growth[i] = 0
  } else {
    growth_by_month$monthly_growth[i] = growth_by_month$total_revenue[i] / growth_by_month$total_revenue[i-1]
  }
}
growth_by_month
growth_by_month$period = 1:nrow(growth_by_month)
ggplot(growth_by_month, aes(x=period, y=monthly_growth, group=1))+
  geom_line(color="red") +
  ggtitle(label = "Wachstum von Total Revenue pro Monat")


# Wachstum für Jahre. Nur volle Jahre.
growth_by_year = shipments[shipments$year != "2017" & shipments$year != "2021",] %>% aggregate(total_revenue ~ year, data = ., sum)
for(i in 1:nrow(growth_by_year)) {
  if(i == 1) {
    growth_by_year$yearly_growth[i] = 0
  } else {
    growth_by_year$yearly_growth[i] = growth_by_year$total_revenue[i] / growth_by_year$total_revenue[i-1]
  }
}

growth_by_year
growth_by_year$period = 1:nrow(growth_by_year)
ggplot(growth_by_year, aes(x=period, y=yearly_growth, group=1))+
  geom_line(color="red") +
  ggtitle(label = "Wachstum Total Revenue pro Jahr")
```




### Korrelation in Shipments und mit Google Data
```{r eval=TRUE}
google_data = read.csv("data/google_data.csv")
google_data
google_data$YearMonth = google_data$Woche %>% as.Date() %>% strftime(., format = "%Y-%m") 

google_data_month = google_data[c("YearMonth","Spedition...Deutschland.", "Transport...Deutschland.")] %>% aggregate(. ~ YearMonth , ., mean)
google_data_month

shipments_month = shipments[c("YearMonth","stops_count","transport_price_booked","transport_cost_assigned","total_revenue","total_cost","total_margin")] %>% aggregate(. ~ YearMonth , ., mean)

shipments_google_month = merge(google_data_month,shipments_month,by=c("YearMonth","YearMonth")) 
shipments_google_month

diesel <- read.csv("data/dieselPreiseMonat.csv", sep=";")
shipments_google_month = merge(shipments_google_month,diesel,by=c("YearMonth","YearMonth")) 
shipments_externals_month_cor = shipments_google_month[c("Dieselkraftstoff","Superbenzin",  "Spedition...Deutschland.","Transport...Deutschland.","stops_count","transport_price_booked","transport_cost_assigned","total_revenue","total_cost","total_margin")] %>% cor() %>% data.frame()

shipments_externals_month_cor

#TODO Instafreight als Korrelation untersuchen
```




```{r eval=TRUE}
# Liniendiagramm Marge 2019-07 - 2019-12
shipments[shipments$year == "2019" & shipments$month > "6",] %>% ggplot(data=., aes(x=shipment_created_at, y=total_margin, group=1)) +
  geom_line() +
  ggtitle(label = "Marge für 2019-07 bis 2019-12 pro Tag")

# Liniendiagramm Marge 2020-07 - 2020-12
shipments[shipments$year == "2020" & shipments$month > "6",] %>% ggplot(data=., aes(x=shipment_created_at, y=total_margin, group=1)) +
  geom_line() +
  ggtitle(label = "Marge für 2020-07 bis 2020-12 pro Tag")
```



*Zeitreihen Analyse*
```{r eval=TRUE}
shipments_margin = shipments[shipments$year != "2017" & shipments$year != "2021",] %>% aggregate(total_margin ~ YearMonth, ., mean)
shipments_margin$period = 1:nrow(shipments_margin)
shipments_margin
#ts_shipments = ts(ts_shipments$total_margin, frequency = 12)

ggplot(shipments_margin, aes(x = period, y = total_margin, group = 1)) + 
  geom_line() +
  
  # Umbenennung der x-Achse
  labs(x = "Periode")


ts_shipments = ts(shipments_margin$total_margin, frequency = 12)
ets_shipments = ets(ts_shipments, model = "ZAA")

cat("\n Zusammenfassung des Modells: \n")
summary(ets_shipments)

cat("\n Urspruengliche Zeitreihe: \n")
ets_shipments$x

cat("\n Residiuen: \n")
ets_shipments$residuals

# Durchschnittliche Abweichung mit  Mean Forecast Error (MFE) berechnen
# Mittelwert(Urspruengliche Zeitreihe - Vorhersagen fuer den gegebenen Zeitraum) 
MFE <- round(mean(as.numeric(ets_shipments$x - ets_shipments$fitted)), 4)
MFE

# Forecast der Variable fcast_Shangh (fuer exponentielle Glaettung) uebergeben
# Der Output zeigt die Forecast-Werte sowie die oberen und unteren Grenzen 
# der 80% und 95% Konfidenzintervalle.
fcast_shipments = forecast(ets_shipments, 12)
```

*1. DataFrame Original Nr. 1 erstellen*
```{r}
# DataFrame erstellen
df_shipments = data.frame(
                   period = seq(1, length(fcast_shipments$x), 1), 
                   value = as.numeric(fcast_shipments$x), 
                   grp = rep("original", length(fcast_shipments$x)))
```

*2. DataFrame Vorhersage Nr. 2 erstellen*
```{r}
# DataFrame erstellen
df_shipments_fcast = data.frame(
  period = seq(1, length(fcast_shipments$fitted) + length(fcast_shipments$mean), 1), 
  value = c(as.numeric(fcast_shipments$fitted), as.numeric(fcast_shipments$mean)), 
  grp = rep("fcast", length(fcast_shipments$fitted) + length(fcast_shipments$mean)))
```

*3. Verbinden der DataFrames Nr. 1 und Nr. 2*
```{r}
# Verbinden der Data Frames
df_EG = rbind(df_shipments, df_shipments_fcast)

# Anzeigen des DataFrame (ausgewaehlte Beobachtungen)
head(df_EG)


ggplot(data = df_EG, aes(x = period, 
                         y = value, colour = grp)) + 
  geom_line() +

  # Beschriftung von x-Achse 90 Grad umgedreht
  theme(axis.text.x = element_text(angle=90, vjust = 0.5, hjust=2, size=6))
```

```{r}
#install.packages("anomalize")
library(tidyverse)
library(anomalize)

#https://otexts.com/fpp2/stl.html



#shipments von 2018-2020 
shipments$shipment_created_at_date = shipments$shipment_created_at %>% as.Date()
shipments_dates = shipments[shipments$shipment_created_at_date >= "2018-01-01" & shipments$shipment_created_at_date <= "2020-12-31",]
shipments_dates = shipments_dates[c("shipment_created_at_date","total_margin")]

alldates = seq(as.Date("2018-01-01"), as.Date("2020-12-31"), by="days")#Erzeuge alle Daten von 2018 bis 2020
dates0 = alldates[!(alldates %in% shipments_dates$shipment_created_at_date)]#Vektor mit alle Daten die shipments_dates fehlen.
dates_and_margin = data.frame(shipment_created_at_date = dates0, total_margin = 0)#DF mit fehlenden Daten und erzeuge total_margin = 0

shipments_complete_dates = rbind(shipments_dates, dates_and_margin)#Verbinde DFs
shipments_complete_dates = shipments_complete_dates[order(shipments_complete_dates$shipment_created_at_date),]#Sortiere

shipments_complete_dates = shipments_complete_dates %>% aggregate(total_margin ~ shipment_created_at_date, ., mean) %>% as_tibble(.)
shipments_complete_dates %>%
    time_decompose(total_margin) %>%
    anomalize(remainder) %>%
    time_recompose() %>%
    plot_anomalies(time_recomposed = TRUE, ncol = 3, alpha_dots = 0.5)

#Auto Einstellungen
shipments_complete_dates %>%
    time_decompose(total_margin) %>%
    anomalize(remainder) %>%
    time_recompose() %>%
    plot_anomalies(time_recomposed = TRUE, ncol = 3, alpha_dots = 0.5)

#Einstellung frequency = 1 Woche, Trend= 1 Jahr. Plot
shipments_complete_dates %>%
    time_decompose(total_margin) %>%
    anomalize(remainder) %>%
  plot_anomaly_decomposition()

#Einstellung frequency = 1 Woche, Trend= 1 Jahr
shipments_complete_dates %>%
    time_decompose(total_margin, frequency = "1 week", trend = "1 year") %>%
    anomalize(remainder) %>%
    time_recompose() %>%
    plot_anomalies(time_recomposed = TRUE, ncol = 3, alpha_dots = 0.5)

#Einstellung frequency = 1 Woche, Trend= 1 Jahr. Plot
shipments_complete_dates %>%
    time_decompose(total_margin, frequency = "1 week", trend = "1 year") %>%
    anomalize(remainder) %>%
  plot_anomaly_decomposition()

# Decomposed shipments data set
decomposed_shipments = shipments_complete_dates %>% time_decompose(total_margin, frequency = "1 week", trend = "1 year") %>% anomalize(remainder)

plot(x=decomposed_shipments$shipment_created_at_date,y=decomposed_shipments$remainder)

# Jahr-Monat Spalte
decomposed_shipments$YearMonth = decomposed_shipments$shipment_created_at_date %>% as.Date() %>% strftime(., format = "%Y-%m") 

# Anomalien entfernen
decomposed_shipments = decomposed_shipments[decomposed_shipments$anomaly == "No",]
decomposed_shipments$anomaly = NULL

# Aggregieren auf JahrMonat
decomposed_shipments_month = decomposed_shipments %>% aggregate(. ~ YearMonth, ., mean)

# Verbinden mit shipments_externals_month_cor
shipments_google_month = merge(shipments_google_month,decomposed_shipments_month,by=c("YearMonth","YearMonth")) 
shipments_google_month

shipments_externals_month_cor = shipments_google_month[c("observed", "season","trend","remainder","Dieselkraftstoff","Superbenzin",  "Spedition...Deutschland.","Transport...Deutschland.","stops_count","transport_price_booked","transport_cost_assigned","total_revenue","total_cost","total_margin")] %>% cor() %>% data.frame()
shipments_externals_month_cor





```

```{r eval=TRUE}
# Google/Diesel/Shipments Daten 
google_data = read.csv("data/google_data.csv")
google_data$YearMonth = google_data$Woche %>% as.Date() %>% strftime(., format = "%Y-%m") 

google_data_month = google_data[c("YearMonth","Spedition...Deutschland.", "Transport...Deutschland.")] %>% aggregate(. ~ YearMonth , ., mean)

shipments_month = shipments[c("YearMonth","stops_count","transport_price_booked","transport_cost_assigned","total_revenue","total_cost","total_margin")] %>% aggregate(. ~ YearMonth , ., mean)

shipments_google_month = merge(google_data_month,shipments_month,by=c("YearMonth","YearMonth")) 

diesel <- read.csv("data/dieselPreiseMonat.csv", sep=";")
shipments_google_month = merge(shipments_google_month,diesel,by=c("YearMonth","YearMonth")) 

# Season/trend Bereinigte Daten von Shipments
decomposed_shipments = shipments_complete_dates %>% time_decompose(total_margin, frequency = "auto", trend = "auto") %>% anomalize(remainder)

plot(x=decomposed_shipments$shipment_created_at_date,y=decomposed_shipments$remainder)

# Jahr-Monat Spalte
decomposed_shipments$YearMonth = decomposed_shipments$shipment_created_at_date %>% as.Date() %>% strftime(., format = "%Y-%m") 

# Anomalien entfernen
decomposed_shipments = decomposed_shipments[decomposed_shipments$anomaly == "No",]
decomposed_shipments$anomaly = NULL

# Aggregieren auf JahrMonat
decomposed_shipments_month = decomposed_shipments %>% aggregate(. ~ YearMonth, ., mean)

# Verbinden mit shipments_externals_month_cor
shipments_google_month = merge(shipments_google_month,decomposed_shipments_month,by=c("YearMonth","YearMonth")) 
shipments_google_month

shipments_externals_month_cor = shipments_google_month[c("observed", "season","trend","remainder","Dieselkraftstoff","Superbenzin",  "Spedition...Deutschland.","Transport...Deutschland.","stops_count","transport_price_booked","transport_cost_assigned","total_revenue","total_cost","total_margin")] %>% cor() %>% data.frame()
shipments_externals_month_cor
```



*Zeitreihen Analyse*
```{r eval=TRUE}
shipments_complete_dates

ggplot(shipments_complete_dates, aes(x = shipment_created_at_date, y = total_margin, group = 1)) + 
  geom_line() +
  
  # Umbenennung der x-Achse
  labs(x = "Periode")


ts_shipments = ts(shipments_complete_dates$total_margin, frequency = 12)
ets_shipments = ets(ts_shipments, model = "ZAA")

cat("\n Zusammenfassung des Modells: \n")
summary(ets_shipments)

cat("\n Urspruengliche Zeitreihe: \n")
ets_shipments$x

cat("\n Residiuen: \n")
ets_shipments$residuals

# Durchschnittliche Abweichung mit  Mean Forecast Error (MFE) berechnen
# Mittelwert(Urspruengliche Zeitreihe - Vorhersagen fuer den gegebenen Zeitraum) 
MFE <- round(mean(as.numeric(ets_shipments$x - ets_shipments$fitted)), 4)
MFE

# Forecast der Variable fcast_Shangh (fuer exponentielle Glaettung) uebergeben
# Der Output zeigt die Forecast-Werte sowie die oberen und unteren Grenzen 
# der 80% und 95% Konfidenzintervalle.
fcast_shipments = forecast(ets_shipments, 12)
```

*1. DataFrame Original Nr. 1 erstellen*
```{r}
# DataFrame erstellen
df_shipments = data.frame(
                   period = seq(1, length(fcast_shipments$x), 1), 
                   value = as.numeric(fcast_shipments$x), 
                   grp = rep("original", length(fcast_shipments$x)))
```

*2. DataFrame Vorhersage Nr. 2 erstellen*
```{r}
# DataFrame erstellen
df_shipments_fcast = data.frame(
  period = seq(1, length(fcast_shipments$fitted) + length(fcast_shipments$mean), 1), 
  value = c(as.numeric(fcast_shipments$fitted), as.numeric(fcast_shipments$mean)), 
  grp = rep("fcast", length(fcast_shipments$fitted) + length(fcast_shipments$mean)))
```

*3. Verbinden der DataFrames Nr. 1 und Nr. 2*
```{r}
# Verbinden der Data Frames
df_EG = rbind(df_shipments, df_shipments_fcast)

# Anzeigen des DataFrame (ausgewaehlte Beobachtungen)
head(df_EG)


ggplot(data = df_EG, aes(x = period, 
                         y = value, colour = grp)) + 
  geom_line() +

  # Beschriftung von x-Achse 90 Grad umgedreht
  theme(axis.text.x = element_text(angle=90, vjust = 0.5, hjust=2, size=6))
```



```{r}
#Differnz zwischen created_at und first_agreed_arrival_to
shipments$diff = shipments$shipment_created_at - shipments$first_stop_agreed_arrival_to

shipments$difference_created_agreed_date = difftime(shipments$first_stop_agreed_arrival_to, shipments$shipment_created_at, units = "days")
plot(x=shipments$shipment_created_at, y=shipments$difference_created_agreed_date, "l")

plot_data = shipments %>% aggregate(difference_created_agreed_date ~ YearMonth, ., mean)


```

*Regression erstellen, Datenerstellen, Korrelation zeigen*
```{r}
require(ggplot2)
require(GGally)
#Datenbereinigung
shipments = shipments[shipments$year >= 2018 & shipments$year <= 2020 & shipments$lane_domain == "national",]


#Korrelationen 
  google_data = read.csv("data/google_data.csv")
  google_data$YearMonth = google_data$Woche %>% as.Date() %>% strftime(., format = "%Y-%m") 
  google_data = google_data[c("YearMonth","Spedition...Deutschland.", "Transport...Deutschland.")] %>% aggregate(. ~ YearMonth , ., mean)
  
  
  shipments_month = shipments[c("YearMonth","stops_count","transport_price_booked","transport_cost_assigned","total_revenue","total_cost","total_margin","OTD")] %>% aggregate(. ~ YearMonth, ., mean)
  
  shipments_externals_month = merge(google_data,shipments_month,by=c("YearMonth","YearMonth")) 
  
  diesel <- read.csv("data/dieselPreiseMonat.csv", sep=";")
  
  shipments_externals_month = merge(shipments_externals_month,diesel,by=c("YearMonth","YearMonth")) 
  shipments_externals_month_cor = shipments_externals_month[c("Dieselkraftstoff","Superbenzin",  "Spedition...Deutschland.","Transport...Deutschland.","stops_count","transport_price_booked","transport_cost_assigned","total_revenue","total_cost","total_margin")] %>% cor() %>% data.frame()
  shipments_externals_month_cor
  
  #Korelationen für total_margin
  cor(shipments_externals_month[c("Dieselkraftstoff","Superbenzin",  "Spedition...Deutschland.","Transport...Deutschland.","stops_count","transport_price_booked","transport_cost_assigned","total_revenue","total_cost","total_margin")],shipments_externals_month[c("total_margin")]) %>% data.frame()
  

# Korrelationsplot für Diesel, Google Spedition, und transport_price_booked
  ggpairs(shipments_externals_month_cor, 
  # ohne Visualisierung des Fortschritts der Erstellung des plots
  progress = FALSE,
  # mit Visualisierung einer Glaettungslinie und Aenderung der Farbe der               
  # Punkte, damit Linie erkennbar
  lower = list(continuous = wrap("smooth_loess", colour = "steelblue1")))
  
```

*Regression erstellen, für Monate*

```{r}
#Funktion für Evaluation von Modellen  
evaluation_function <- function(evaluation, model) {
          # Modelname
          modelname = deparse(substitute(model))
          
          # DF erweitern.
          evaluation = rbind(evaluation, data.frame(Model = 
                               modelname, MAE = numeric(1), sMAPE = numeric(1), r  = as.numeric(1), r2  = as.numeric(1))) 
          
          # MAE berechnen.
          evaluation[evaluation$Model == modelname,]$MAE = (model$residuals) %>% abs(.) %>% mean(.)
          
          # sMAPE berechnen.
          evaluation[evaluation$Model == modelname,]$sMAPE = smape(model$model[,1], model$fitted.values)
          
          # R berechnen.TODO Richtig Berechnung einfügen
          evaluation[evaluation$Model == modelname,]$r = smape(model$model[,1], model$fitted.values)
          
          # R**2 berechnen.TODO Richtig Berechnung einfügen
          evaluation[evaluation$Model == modelname,]$r2 = smape(model$model[,1], model$fitted.values)
          
          evaluation %>% unique() %>% return()
}
  

```

```{r}
#Baseline erstellen, durschnittliche Marge vom Monat.
  baseline = shipments %>% aggregate(total_margin ~ month , ., mean)
  names(baseline)[2] = "total_margin_baseline"
  baseline_3y = rbind(baseline,baseline)
  baseline_3y = rbind(baseline_3y,baseline)
  
#Baseline Bewertung aufstellen
  # DataFrame erzeugen, dass bei auf die Beschreibung ("Model") leer bzw. 0 ist
  evaluation = data.frame(Model = "Baseline",
                          MAE = numeric(1),
                          sMAPE = numeric(1),
                          r = numeric(1),
                          r2 = numeric(1))
  
  # MAE berechnen
  evaluation[evaluation$Model == "Baseline",]$MAE = (shipments_externals_month$total_margin - baseline_3y$total_margin) %>% abs() %>% mean()
  
  # sMAPE berechnen
  evaluation[evaluation$Model == "Baseline",]$sMAPE = smape(shipments_externals_month$total_margin, baseline_3y$total_margin_baseline)
  
  # R berechnen # R berechnen.TODO Richtig Berechnung einfügen
  evaluation[evaluation$Model == "Baseline",]$r = smape(shipments_externals_month$total_margin, baseline_3y$total_margin_baseline)
  
  # R**2 berechnen # R**2 berechnen.TODO Richtig Berechnung einfügen
  evaluation[evaluation$Model == "Baseline",]$r2 = smape(shipments_externals_month$total_margin, baseline_3y$total_margin_baseline)
  
  evaluation
```
  
```{r}  
#Trainings und Testdaten erzeugen. (80/20)
  
  # Erzeuge iterative Zahlenreihe statt Periode
  shipments_externals_month$period = 1:nrow(shipments_externals_month)
  
  # Einen zufaelligen Zustand herstellen 
  set.seed(4141)
  
  # Zufallsaufwahl erstellen:
  zufall = sample(1:nrow(shipments_externals_month), nrow(shipments_externals_month) * 0.8)
  
  # Die Eintraege in der Zufallsauswahl gehen in das TrainingsSet
  shipments_monthsTraining = shipments_externals_month[zufall, ]
  
  # Die Eintraege nicht in der Zufallsauswahl gehen in das TestSet (20%)
  shipments_monthsTest = shipments_externals_month[-zufall, ]
  
  #Tabellenkopf ausgeben
  head(shipments_monthsTraining)
  head(shipments_monthsTest)

```

```{r}
#Modell erstellen, 1. Iteration
  m1_1 = shipments_monthsTraining %>% lm(total_margin ~ Dieselkraftstoff, .)
  m1_2 = shipments_monthsTraining %>% lm(total_margin ~ Spedition...Deutschland., .)
  m1_3 = shipments_monthsTraining %>% lm(total_margin ~ Transport...Deutschland., .)
  
  evaluation = evaluation_function(evaluation, m1_1)
  evaluation = evaluation_function(evaluation, m1_2)
  evaluation = evaluation_function(evaluation, m1_3)
  
  evaluation

```

```{r}
#Modell erstellen, 2. Iteration
  m1_2_1 = shipments_monthsTraining %>% lm(total_margin ~ Spedition...Deutschland. + Dieselkraftstoff, .)
  m1_2_3 = shipments_monthsTraining %>% lm(total_margin ~ Spedition...Deutschland. + Transport...Deutschland., .)
  
  evaluation = evaluation_function(evaluation, m1_2_1)
  evaluation = evaluation_function(evaluation, m1_2_3)
  
  evaluation

```

```{r}
# Residuenplot Beispiel
ggplot(data = NULL, aes(x = m1_2$model$total_margin, y = m1_2_1$residuals)) + 
  geom_point() + 
  geom_smooth(se = FALSE, method = loess) + 
  ggtitle("Plot m1_1_4") +
  xlab("total_margin") + ylab("Residuals")
```


```{r}
#install.packages("readxl")
#library(readxl)

# Korrelationen suchen
  #Shipments
  shipments2 = shipments[shipments$year >= 2018 & shipments$year <= 2020 & shipments$lane_domain == "national",]
  shipments_cor = shipments2[c("YearMonth","stops_count","transport_price_booked","transport_cost_assigned","total_revenue","total_cost","total_margin","OTD")] %>% aggregate(. ~ YearMonth, ., mean)
  
  #Google Trends
  google_data = read.csv("data/google_data.csv")
  google_data$YearMonth = google_data$Woche %>% as.Date() %>% strftime(., format = "%Y-%m")# Jahr-Monat Spalte
  google_data = google_data[c("YearMonth","Spedition...Deutschland.", "Transport...Deutschland.")] %>% aggregate(. ~ YearMonth , ., mean)
  shipments_cor = merge(shipments_cor,google_data,by=c("YearMonth","YearMonth"))
  
  #Diesel
  diesel <- read.csv("data/dieselPreiseMonat.csv", sep=";")
  shipments_cor = merge(shipments_cor,diesel,by=c("YearMonth","YearMonth"))
  
  #LKW-Maut_Fahrleistungsindex
  Lkw_Maut_Fahrleistungsindex = read.csv("data/Lkw-Maut-Fahrleistungsindex.csv", sep=";")
  shipments_cor = merge(shipments_cor,Lkw_Maut_Fahrleistungsindex,by=c("YearMonth","YearMonth"))
  
  #DAX
  DAX = read_excel("data/Dax 2017 bis 2020.xlsx", sheet = 1)
  DAX$daxDayMean = (DAX$Eröffnung + DAX$Schluss) / 2
  DAX$YearMonth = DAX$Datum %>% as.Date() %>% strftime(., format = "%Y-%m")# Jahr-Monat Spalte
  DAX = DAX[c("YearMonth","daxDayMean")] %>% aggregate(. ~ YearMonth , ., mean)
  shipments_cor = merge(shipments_cor,DAX,by=c("YearMonth","YearMonth"),all.x = TRUE)
  

  shipments_cor$YearMonth = NULL

  shipments_correlations = shipments_cor %>% cor()
  shipments_correlations
  
  #Barometer
  
  

```

