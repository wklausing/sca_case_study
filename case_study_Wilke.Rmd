---
title: "case_study"
author: "klauwi"
date: "2/3/2021"
output: html_document
---

Library Packages
```{r}
#rm(list = ls())
library("tidyverse")
```

***Aufgabe A: Erkenntnisgewinn***
Ziel der Aufgabe ist der Bericht von etwaigen Erkenntnissen über die Daten, 
die Sie im Laufe der Projektbearbeitung erlangt haben. 
Zudem soll gezielt über die in der Fallstudienbeschreibung geforderten Punkte berichtet werden. 
Die Daten sollen angemessen aufbereitet und visualisiert werden. 
Wenn möglich sollen Handlungsempfehlungen aus den Erkenntnissen abgeleitet werden. 
Zu diesem Zweck können Sie beispielsweise folgendes nutzen:

• *Visuelle Exploration*
- Datenbereinigung #Wilke, erledigt
- Grafik Cost und Renvue #Wilke, erledigt
- Grafik zu (transport_price_booked + transport_cost_assigned) #Anny, erledigt
- Grafik zu Marge allein um Schwankungen zu identifizieren #Anny, erledigt

• Kennzahlen und Reporting:
  - *Identifikation von Muster (zB Saisonalitäten, Trends, ...)*
  - *Korrelationen* 
    > Interne Korrelation #Dinh
    > Externe Daten #Anny, Wilke, Toke
  - *Methoden der deskriptiven Statistik (Clustering, Times Series...)* #Toke
  
Versuchen Sie einen möglichst guten Überblick über die Shipment-Daten zu generieren. 
Gehen Sie dabei schon gezielt auf die *Marge* ein (sowohl die *zeitliche Entwicklung* als auch identifizierte Zusammenhänge). Achten Sie bei Ihren Interpretationen auf die Gültigkeit von Aussagen über Kausalitäten.
Der Lösungsraum dieser Teilaufgabe geht ins Unermessliche. 
Beschränken Sie sich in Ihrer Präsentation daher auf eine Auswahl an Inhalten, die Ihnen besonders wichtig und präsentationswürdig erscheinen. Bereiten Sie gegebenenfalls ein Portfolio im Back-Up Ihrer Präsentation vor, um auf Anschlussfragen reagieren zu können. Sie sollten bei Ihrer Vorstellung dieser Teilaufgabe versuchen Zusammenhänge zu interpretieren und Implikationen abzuleiten, selbst wenn Ihre erarbeiteten Inhalte durch experimentelle Untersuchungen entstanden sind.


***(1) Datenvorbereitung***
### (1.1) CSV Dateien einlesen 
```{r eval=FALSE}
# Shipments Daten einlesen und ins richtige Format bringen.
shipments <- read.csv("data/shipment_FINAL_20210115.csv")
# Timestamps
shipments$shipment_created_at = as.POSIXct(shipments$shipment_created_at,tz=Sys.timezone())

shipments[shipments$smh_accepted_first_state_change == "",]$smh_accepted_first_state_change = NA
shipments$smh_accepted_first_state_change = as.POSIXct(shipments$smh_accepted_first_state_change,tz=Sys.timezone())  

shipments[shipments$smh_accepted_last_state_change == "",]$smh_accepted_last_state_change = NA
shipments$smh_accepted_last_state_change = as.POSIXct(shipments$smh_accepted_last_state_change,tz=Sys.timezone())  

shipments$first_stop_requested_arrival_to = as.POSIXct(shipments$first_stop_requested_arrival_to,tz=Sys.timezone())  

shipments$first_stop_agreed_arrival_to = as.POSIXct(shipments$first_stop_agreed_arrival_to,tz=Sys.timezone())

shipments[shipments$last_stop_agreed_arrival_to == "",]$last_stop_agreed_arrival_to = NA
shipments$last_stop_agreed_arrival_to = as.POSIXct(shipments$last_stop_agreed_arrival_to,tz=Sys.timezone())

shipments[shipments$first_stop_actual_arrival == "",]$first_stop_actual_arrival = NA
shipments$first_stop_actual_arrival = as.POSIXct(shipments[shipments$first_stop_actual_arrival != "",]$first_stop_actual_arrival,tz=Sys.timezone())

shipments[shipments$last_stop_requested_arrival_to == "",]$last_stop_requested_arrival_to = NA
shipments$last_stop_requested_arrival_to = as.POSIXct(shipments$last_stop_requested_arrival_to,tz=Sys.timezone())

shipments[shipments$last_stop_actual_arrival == "",]$last_stop_actual_arrival = NA
shipments$last_stop_actual_arrival = as.POSIXct(shipments[shipments$last_stop_actual_arrival != "",]$last_stop_actual_arrival,tz=Sys.timezone())

shipments[shipments$sh_cancelled == "",]$sh_cancelled = NA
shipments$sh_cancelled = as.POSIXct(shipments[shipments$sh_cancelled != "",]$sh_cancelled,tz=Sys.timezone())

# Dates
shipments$first_stop_requested_arrival_to_date = shipments$first_stop_requested_arrival_to_date %>% as.Date()
shipments$last_stop_requested_arrival_to_date = shipments$last_stop_requested_arrival_to_date %>% as.Date()

# Erzeuge total_margin Spalte. (total_margin = total_revenue - total_cost)
shipments$total_margin = shipments$total_revenue - shipments$total_cost

# Erzeuge Spalte für Jahr. Monat, Tag
shipments = shipments %>%
  dplyr::mutate(year = lubridate::year(shipment_created_at), 
                month = lubridate::month(shipment_created_at), 
                day = lubridate::day(shipment_created_at))

# Jahr-Monat Spalte
shipments$YearMonth = shipments$shipment_created_at %>% as.Date() %>% strftime(., format = "%Y-%m") 


# Margin Daten einlesen 
margin <- read.csv2("data/margin_by_week_FINAL_20210115.csv")
```
***Datenbereinigung***
```{r eval=FALSE}
# Shipments Datenbereinigung
#1. Entferne Zeilen mit leerer lane_domain. Betrifft 2 Zeilen.  
shipments = shipments[shipments$lane_domain != "",]

#2. Entferne Zeilen mit cancellation_reason = fake_order. Betrifft 1622 Zeilen.
shipments = shipments[shipments$cancellation_reason != "fake_order",]

#3. Ändere 2024 zu 2020 in last_stop_requested_arrival_to und last_stop_requested_arrival_to_date Spalte. Betrifft 1 Zeile.
shipments[shipments$last_stop_requested_arrival_to == "2024-11-20 07:00:00",]$last_stop_requested_arrival_to = "2020-11-20 07:00:00"
shipments[shipments$last_stop_requested_arrival_to_date == "2024-11-20",]$last_stop_requested_arrival_to_date = "2020-11-20"

#4. Ändere 0019 zu 2019. Betrifft 1 Zeile.
shipments[!is.na(shipments$first_stop_actual_arrival) & shipments$first_stop_actual_arrival == "0019-08-20 01:53:28",]$first_stop_actual_arrival = as.POSIXct("2019-08-20 01:53:28",tz=Sys.timezone())

#5. Prüfen auf Duplikate insgesamt und für shipment_reference speziell. Betrifft 0 Zeilen.
#shipments = shipments %>%  distinct(.)
#shipments <- shipments[!duplicated(shipments$shipment_reference),]

#6. Entferne ersten 4 Zeilen, siehe Forum. Betrifft 4 Zeilen.
shipments = shipments[-1:-4,]

#7. Entferne weitere Zeile, da es nur 1 Tag vom ganzen Monat ist. Betrifft 1 Zeile.
shipments = shipments[-1,]

#8. Entferne Zeile mit -1 in transport_cost_assigned, da dies laut Dokumentation nicht sein kann. Selbes für transport_price_booked. Betrifft 1 Zeile.
shipments = shipments[shipments$transport_price_booked >= 0 & shipments$transport_cost_assigned >= 0,]

#9. Ausreißer bei total_revenue und total_cost entfernen.
plot(x=shipments$total_revenue, y=shipments$total_cost)# Vorher
shipments = shipments[shipments$total_revenue < 5000 & shipments$total_revenue > -1000 & shipments$total_cost > -1000,]
plot(x=shipments$total_revenue, y=shipments$total_cost)# Nachher

#10. transport_cost_assigned und transport_price_booked dürfen nur größer/gleich 0 sein. 
shipments = shipments[shipments$transport_cost_assigned >= 0 & shipments$transport_price_booked >= 0,]

#11. Entferne Zeilen die nur NA haben.
shipments = shipments[!is.na(shipments$shipment_reference), ]

#12. Die Spalte `country_lane` wird in eine Spalte `origin_country` und eine Spalte ´destination_country´ aufgeteilt 
shipments <- shipments %>%
  separate(country_lane, c("origin_country","destination_country"), "-->>")

#TODO OTD noch berechnen

# Dataframes abspeichern
saveRDS(shipments, "data/shipments.rds")
saveRDS(margin, "data/margins.rds")
```
***Vorbereiteten Daten aus RDS Dateien einlesen***
```{r eval=TRUE}
shipments = readRDS(file = "data/shipments.rds")
margin = readRDS(file = "data/margins.rds")
```

### (1.2) Struktur ausgeben
```{r eval=TRUE}
head(shipments)
str(shipments)

head(margin)
str(margin)
```

***Daten Formatieren: Zeitliche Entwicklung***
### (1.3) JAHR-MONAT extrahieren
```{r eval=FALSE}
# Extrahieren von Jahr-Monat aus Shipment-Spalte "last_stop_requested_arrival_to_date", 
# da diese Spalte auch in Margin-Spalte vorhanden ist
x <- as.Date(TableBind$last_stop_requested_arrival_to_date, format="%Y-%m-%d")

# Jahr-Monat an die Shipment Spalte hinten anhaengen
TableBind$YearMonth = format(x,"%Y-%m")

#Info: Benoetigen wir spaeter fuer die Zeitreihenanalyse und Vorhersage
```


***(2) Visuelle Exploration (mit Aggregation)***
### (2.1) Shipments Gegenueberstellung: total_cost und total_revenue
```{r eval=FALSE}
# Umsatz aggrerieren
df_Revenue = data.frame(aggregate(
  total_revenue ~ business_model + fulfilment_strategy, data=TableBind, sum))

# Kosten aggrerieren
df_Cost = data.frame(aggregate(
  total_cost ~ business_model + fulfilment_strategy, data=TableBind, sum))

# Beide DataFrames mergen
df_Compare = cbind(df_Revenue, df_Cost$total_cost)

# Umbenennen
colnames(df_Compare)[4] = "total_cost"
df_Compare
```

### (2.2) Zwei Liniendiagramme zu Shipment Kosten, Umsatz und Marge
```{r eval=TRUE}
# Verkettung der zwei Tabellen: Shipments + Mergin
# Datum von Shipment Spalte "last_stop_requested_arrival_to_date" so umformatieren, dass Kalenderwoche angezeigt wird
YearMonthFormat = as.Date(shipments$shipment_created_at)
shipments$YearMonth = strftime(YearMonthFormat, format = "%Y-%m") #Jahr-Monat

# Revenue und Costdarstellen
shipments_week_aggregated = shipments[c("YearMonth", "total_revenue", "total_cost")] %>% 
  aggregate(. ~ YearMonth, data = ., sum)
shipments_week_aggregated$margin = 
  shipments_week_aggregated$total_revenue - shipments_week_aggregated$total_cost
shipments_week_aggregated 

# Liniendiagram von Kosten, Umsatz und Marge
ggplot(data = shipments_week_aggregated, aes(x = YearMonth, group=1)) + 
  geom_line(aes(y = total_cost), colour="red") + 
  geom_line(aes(y = total_revenue), colour="darkgreen") +
  geom_line(aes(y = margin), colour="black") + 
  xlab("Date") +  
  ylab("Euro") +
  ggtitle(label = "Instafreight: Umsatz, Kosten und Marge (2017-2021)") +
  theme(axis.text.x = element_text(angle=45, vjust = 1.1, hjust=1.2, size=8)) + 
    #y-Achse Zahlen als Integer-Wert deklarieren
    scale_y_continuous(labels = scales::number_format(accuracy = 100)) +
    scale_x_discrete(breaks = shipments_week_aggregated$YearMonth[seq(1, length(shipments_week_aggregated$YearMonth), by = 2)]) 


# Zweites Liniendiagram nur mit Marge
ggplot(data = shipments_week_aggregated, aes(x = YearMonth, group=1)) +
  geom_line(aes(y = margin), colour="black") + 
  xlab("Date") +  
  ylab("Euro") +
  ggtitle(label = "Instafreight: Marge (2017-2021)") +
  theme(axis.text.x = element_text(angle=45, vjust = 1.1, hjust=1.2, size=8)) + 
    #y-Achse Zahlen als Integer-Wert deklarieren
    scale_y_continuous(breaks = function(x) unique(floor(pretty(seq(0, (max(x) + 1) * 1.1))))) +
    # Periode in 6 Jahrsabstaenden wiedergeben
    scale_x_discrete(breaks = shipments_week_aggregated$YearMonth[seq(1, length(shipments_week_aggregated$YearMonth), by = 2)])

#TODO Y besser darstellen
#TODO Legende fehlt
```

### (2.3) Ein Liniendiagramm zu Shipment transport_price_booked + transport_cost_assigned
```{r eval=TRUE}
# Aggregieren
shipments_week_aggregated = shipments[c("YearMonth", "transport_price_booked", "transport_cost_assigned")] %>% 
  aggregate(. ~ YearMonth, data = ., sum)
shipments_week_aggregated$difference = 
  shipments_week_aggregated$transport_price_booked - shipments_week_aggregated$transport_cost_assigned
shipments_week_aggregated 


# Liniendiagramm Uebersicht
ggplot(data = shipments_week_aggregated, aes(x = YearMonth, group=1)) + 
  geom_line(aes(y = transport_price_booked), colour="red") + 
  geom_line(aes(y = transport_cost_assigned), colour="blue") +
  geom_line(aes(y = difference), colour="black") + 
  xlab("Date") +  
  ylab("Euro") +
  ggtitle(label = "Instafreight: Buchungspreis, Transportkosten und Differenz (2017-2021)") +
  theme(axis.text.x = element_text(angle=45, vjust = 1.1, hjust=1.2, size=8)) + 
  #y-Achse Zahlen als Integer-Wert deklarieren
  scale_y_continuous(labels = scales::number_format(accuracy = 100)) +
  scale_x_discrete(breaks = shipments_week_aggregated$YearMonth[seq(1, length(shipments_week_aggregated$YearMonth), by = 2)])

```


### (2.4) 
```{r eval=TRUE}
# Revenue und Costdarstellen
shipments_week_aggregated = shipments[c("shipment_created_at", "total_revenue", "total_cost")] %>% aggregate(. ~ shipment_created_at, data = ., sum)
shipments_week_aggregated$profit = shipments_week_aggregated$total_revenue - shipments_week_aggregated$total_cost

ggplot(data = shipments_week_aggregated, aes(x = shipment_created_at, group=1)) + 
  geom_line(aes(y = total_cost), colour="red") + 
  geom_line(aes(y = total_revenue), colour="blue") +
  geom_line(aes(y = profit), colour="black") + 
  xlab("Date") +  
  ylab("Euro") +
  ggtitle(label = "Instafreight: Revenue, Cost, and Profit group by shipment_created_at") +
  theme(axis.text.x = element_text(angle=45, vjust = 1.1, hjust=1.2, size=8)) +
  scale_y_continuous(breaks=NULL)

#TODO X Achse zu Monaten umwandeln
#TODO Ausreisser bereinigen.
```

### (2.5) Shipments Gegenuberstellung: Lieferungskosten gebucht und zugewiesen
```{r eval=TRUE}
group1 = aggregate(transport_price_booked ~ 
                     fulfilment_strategy + business_model, data=shipments, sum)
group2 = aggregate(transport_cost_assigned  ~ 
                     fulfilment_strategy + business_model, data=shipments, sum)

differenz = group1[3] - group2[3]
colnames(differenz) = "differenz"

# Spalten von Dataframes werden verbunden
groupbind = cbind(group1, group2[3], differenz)
groupbind

#TODO: Datenbereinigen mit unique() und ungleich null
#TODO: Grafik von entstandene Kosten bei Lieferung waere gut
```

```{r eval = false}
# Shipments: Prüfen ob Ausprägungen mit der Dokumentation übereinstimmen.
shipments$shipment_state %>% unique(.)
shipments$shipment_stage %>% unique(.)
shipments$business_model %>% unique(.)
shipments$custom_rate_shipment %>% unique(.)
shipments$lane_domain %>% unique(.)
shipments$country_lane %>% unique(.)
shipments$stops_count %>% unique(.)
shipments$cancellation_reason %>% unique(.)

```

```{r}
# Shipments: Balkendiagram für cancellation_reason
total_shipments = shipments %>% nrow()
total_cancelled_shipments = shipments[shipments$cancellation_reason != "",] %>% nrow()

success_rate = 1 - total_cancelled_shipments / total_shipments
success_rate
# 92.75% aller shipments sind erfolgreich, 7.25% nicht.
```

```{r eval = false}
# Shipments: Balkendiagram für cancellation_reason
shipments[shipments$cancellation_reason != "",]$cancellation_reason %>% table(.) %>%  barplot(., names=unique(shipments[shipments$cancellation_reason != "",]$cancellation_reason), las=2, cex.names=.6)
```

```{r eval = false}
# Shipments: Vergleich von Plot 
shipments_customer_not_ready = shipments[shipments$cancellation_reason == "customer_not_ready",]

plot(x=shipments_customer_not_ready$total_revenue, y=shipments_customer_not_ready$total_cost)

#Bei 220 und 320 Revenue scheinen vllt Fixkosten für Kunden zu sein wen diese absagen, da sich an diesen Stellen Linien bilden.
```

```{r eval = false}
#TODO Shipments: total_cost = 1 und total_revenue = 1. Aussortieren? Betrifft 276 Zeilen
weird_shipments = shipments[shipments$total_cost == 1 & shipments$total_revenue == 1,]
weird_shipments
```

```{r eval = false}
#Auffälligkeiten bei Preisen und Kosten suchen. Am besten einfach mit Table und nach Häufigkeit sortieren.
shipments$transport_cost_assigned %>% table(.) %>%  barplot(.)
shipments$total_cost %>% table(.) %>%  barplot(.)

shipments$transport_price_booked %>% table(.) %>%  barplot(.)
shipments$total_revenue %>% table(.) %>%  barplot(.)
```


```{r eval = false}
#
#Wachstum für Monate.
growth_by_month = shipments %>% aggregate(total_revenue ~ year+month , data = ., sum)
growth_by_month = growth_by_month[order(growth_by_month$year, growth_by_month$month ),]

for(i in 1:nrow(growth_by_month)) {
  if(i == 1) {
    growth_by_month$monthly_growth[i] = 0
  } else {
    growth_by_month$monthly_growth[i] = growth_by_month$total_revenue[i] / growth_by_month$total_revenue[i-1]
  }
}
growth_by_month
growth_by_month$period = 1:nrow(growth_by_month)
ggplot(growth_by_month, aes(x=period, y=monthly_growth, group=1))+
  geom_line(color="red") +
  ggtitle(label = "Wachstum von Total Revenue pro Monat")


# Wachstum für Jahre. Nur volle Jahre.
growth_by_year = shipments[shipments$year != "2017" & shipments$year != "2021",] %>% aggregate(total_revenue ~ year, data = ., sum)
for(i in 1:nrow(growth_by_year)) {
  if(i == 1) {
    growth_by_year$yearly_growth[i] = 0
  } else {
    growth_by_year$yearly_growth[i] = growth_by_year$total_revenue[i] / growth_by_year$total_revenue[i-1]
  }
}
growth_by_year
growth_by_year$period = 1:nrow(growth_by_year)
ggplot(growth_by_year, aes(x=period, y=yearly_growth, group=1))+
  geom_line(color="red") +
  ggtitle(label = "Wachstum Total Revenue pro Jahr")


```




### Korrelation Google Data
```{r eval=TRUE}
correlations = shipments[c("stops_count","transport_price_booked","transport_cost_assigned","total_revenue","total_cost")] %>% cor() %>% data.frame()
correlations

google_data <- read.csv("data/google_data.csv")
YearMonthFormat = as.Date(google_data$Woche)
google_data$YearMonth = strftime(YearMonthFormat, format = "%Y-%m") #Jahr-Monat
google_data_by_month = google_data %>% aggregate(Spedition...Deutschland. ~ YearMonth , data = ., mean)

google_data_by_month$number = 1:nrow(google_data_by_month)
google_data_by_month
plot(x=google_data_by_month$number, y=google_data_by_month$Spedition...Deutschland., type = "l")



wilke = shipments %>% aggregate(total_revenue ~ YearMonth , data = ., mean)
wilke$number = 1:nrow(wilke)
wilke
plot(x=wilke$number, y=wilke$total_revenue, type = "l")

#correlations = data.frame(cor(shipments$, google_data$Spedition...Deutschland.))

```




```{r eval=TRUE}
# Liniendiagramm Marge 2019-07 - 2019-12
shipments[shipments$year == "2019" & shipments$month > "6",] %>% ggplot(data=., aes(x=shipment_created_at, y=total_margin, group=1)) +
  geom_line() +
  ggtitle(label = "Marge für 2019-07 bis 2019-12 pro Tag")

# Liniendiagramm Marge 2020-07 - 2020-12
shipments[shipments$year == "2020" & shipments$month > "6",] %>% ggplot(data=., aes(x=shipment_created_at, y=total_margin, group=1)) +
  geom_line() +
  ggtitle(label = "Marge für 2020-07 bis 2020-12 pro Tag")
```












