---
title: "case_study"
author: "klauwi"
date: "2/3/2021"
output: html_document
---

Library Packages
```{r}
#rm(list = ls())
library("tidyverse")
```

```{r eval=TRUE}
# Shipments Daten einlesen und ins richtige Format bringen.
shipments <- read.csv("data/shipment_FINAL_20210115.csv")
# Timestamps
shipments$shipment_created_at = as.POSIXct(shipments$shipment_created_at,tz=Sys.timezone())

shipments[shipments$smh_accepted_first_state_change == "",]$smh_accepted_first_state_change = NA
shipments$smh_accepted_first_state_change = as.POSIXct(shipments$smh_accepted_first_state_change,tz=Sys.timezone())  

shipments[shipments$smh_accepted_last_state_change == "",]$smh_accepted_last_state_change = NA
shipments$smh_accepted_last_state_change = as.POSIXct(shipments$smh_accepted_last_state_change,tz=Sys.timezone())  

shipments$first_stop_requested_arrival_to = as.POSIXct(shipments$first_stop_requested_arrival_to,tz=Sys.timezone())  

shipments$first_stop_agreed_arrival_to = as.POSIXct(shipments$first_stop_agreed_arrival_to,tz=Sys.timezone())

shipments[shipments$last_stop_agreed_arrival_to == "",]$last_stop_agreed_arrival_to = NA
shipments$last_stop_agreed_arrival_to = as.POSIXct(shipments$last_stop_agreed_arrival_to,tz=Sys.timezone())

shipments[shipments$first_stop_actual_arrival == "",]$first_stop_actual_arrival = NA
shipments$first_stop_actual_arrival = as.POSIXct(shipments[shipments$first_stop_actual_arrival != "",]$first_stop_actual_arrival,tz=Sys.timezone())

shipments[shipments$last_stop_requested_arrival_to == "",]$last_stop_requested_arrival_to = NA
shipments$last_stop_requested_arrival_to = as.POSIXct(shipments$last_stop_requested_arrival_to,tz=Sys.timezone())

shipments[shipments$last_stop_actual_arrival == "",]$last_stop_actual_arrival = NA
shipments$last_stop_actual_arrival = as.POSIXct(shipments[shipments$last_stop_actual_arrival != "",]$last_stop_actual_arrival,tz=Sys.timezone())

shipments[shipments$sh_cancelled == "",]$sh_cancelled = NA
shipments$sh_cancelled = as.POSIXct(shipments[shipments$sh_cancelled != "",]$sh_cancelled,tz=Sys.timezone())

# Dates
shipments$first_stop_requested_arrival_to_date = shipments$first_stop_requested_arrival_to_date %>% as.Date()
shipments$last_stop_requested_arrival_to_date = shipments$last_stop_requested_arrival_to_date %>% as.Date()

# Margin Daten einlesen 
margin <- read.csv("data/margin_by_week_FINAL_20210115.csv")

head(shipments)
head(margin)
```

### (1.2) Struktur ausgeben
```{r eval=FALSE}
str(shipments)
str(margin)
```

***Datenbereinigung***
```{r eval=TRUE}
# Shipments Datenbereinigung
#1. Entferne Zeilen mit leerer lane_domain. Betrifft 2 Zeilen.  
shipments = shipments[shipments$lane_domain != "",]

#2. Entferne Zeilen mit cancellation_reason = fake_order. Betrifft 1622 Zeilen.
shipments = shipments[shipments$cancellation_reason != "fake_order",]

#3. Ändere 2024 zu 2020 in last_stop_requested_arrival_to und last_stop_requested_arrival_to_date Spalte. Betrifft 1 Zeile.
shipments[shipments$last_stop_requested_arrival_to == "2024-11-20 07:00:00",]$last_stop_requested_arrival_to = "2020-11-20 07:00:00"
shipments[shipments$last_stop_requested_arrival_to_date == "2024-11-20",]$last_stop_requested_arrival_to_date = "2020-11-20"

#4. Ändere 0019 zu 2019. Betrifft 1 Zeile.
shipments$first_stop_actual_arrival = ifelse(!is.na(shipments$first_stop_actual_arrival) & shipments$first_stop_actual_arrival == "0019-08-20 01:53:28", "2019-08-20 01:53:28", NA)

#5. Prüfen auf Duplikate insgesamt und für shipment_reference speziell. Betrifft 0 Zeilen.
#shipments = shipments %>%  distinct(.)
#shipments <- shipments[!duplicated(shipments$shipment_reference),]

#6. Entferne ersten 4 Zeilen, siehe Forum. Betrifft 4 Zeilen.
shipments = shipments[-1:-4,]

#7. Entferne weitere Zeile, da es nur 1 Tag vom ganzen Monat ist. Betrifft 1 Zeile.
shipments = shipments[-1,]

#8. Entferne Zeile mit -1 in transport_cost_assigned, da dies laut Dokumentation nicht sein kann. Betrifft 1 Zeile.
shipments = shipments[shipments$transport_cost_assigned != -1,]

#9. Ausreißer bei total_revenue und total_cost entfernen.
plot(x=shipments$total_revenue, y=shipments$total_cost)# Vorher
shipments = shipments[shipments$total_revenue < 5000 & shipments$total_revenue > -1000 & shipments$total_cost > -1000,]
plot(x=shipments$total_revenue, y=shipments$total_cost)# Nachher

#10. transport_cost_assigned und transport_price_booked dürfen nur größer/gleich 0 sein. 
shipments = shipments[shipments$transport_cost_assigned >= 0 & shipments$transport_price_booked >= 0,]

#TODO OTD noch berechnen

```

### (1) Verkettung der zwei Tabellen: Shipments + Mergin
```{r}
# Datum von Shipment Spalte "last_stop_requested_arrival_to_date" so umformatieren, dass Kalenderwoche angezeigt wird
CalendarWeekFormat = as.Date(shipments$shipment_created_at)
shipments$CalendarWeek = strftime(CalendarWeekFormat, format = "%Y-%V") #Y-CalendarWeek

# Revenue und Costdarstellen
shipments_week_aggregated = shipments[c("CalendarWeek", "total_revenue", "total_cost")] %>% aggregate(. ~ CalendarWeek, data = ., sum)
shipments_week_aggregated$profit = shipments_week_aggregated$total_revenue - shipments_week_aggregated$total_cost

ggplot(data = shipments_week_aggregated, aes(x = CalendarWeek, group=1)) + 
  geom_line(aes(y = total_cost), colour="red") + 
  geom_line(aes(y = total_revenue), colour="blue") +
  geom_line(aes(y = profit), colour="black") + 
  xlab("Date") +  
  ylab("Euro") +
  ggtitle(label = "Instafreight: Revenue, Cost, and Profit group by CalendarWeek") +
  theme(axis.text.x = element_text(angle=45, vjust = 1.1, hjust=1.2, size=8)) + 
  scale_x_discrete(breaks = shipments_week_aggregated$CalendarWeek[seq(1, length(shipments_week_aggregated$CalendarWeek), by = 6)])

#TODO X Achse zu Monaten umwandeln
```

```{r}
# Revenue und Costdarstellen
shipments_week_aggregated = shipments[c("shipment_created_at", "total_revenue", "total_cost")] %>% aggregate(. ~ shipment_created_at, data = ., sum)
shipments_week_aggregated$profit = shipments_week_aggregated$total_revenue - shipments_week_aggregated$total_cost

ggplot(data = shipments_week_aggregated, aes(x = shipment_created_at, group=1)) + 
  geom_line(aes(y = total_cost), colour="red") + 
  geom_line(aes(y = total_revenue), colour="blue") +
  geom_line(aes(y = profit), colour="black") + 
  xlab("Date") +  
  ylab("Euro") +
  ggtitle(label = "Instafreight: Revenue, Cost, and Profit group by shipment_created_at") +
  theme(axis.text.x = element_text(angle=45, vjust = 1.1, hjust=1.2, size=8))

#TODO X Achse zu Monaten umwandeln
#TODO Ausreisser bereinigen.
```





```{r}
#Prüfen ob Ausprägungen mit der Dokumentation übereinstimmen.
shipments$shipment_state %>% unique(.)
shipments$shipment_stage %>% unique(.)
shipments$business_model %>% unique(.)
shipments$custom_rate_shipment %>% unique(.)
shipments$lane_domain %>% unique(.)
shipments$country_lane %>% unique(.)
shipments$stops_count %>% unique(.)
shipments$cancellation_reason %>% unique(.)

```


wilke = shipments[1:10,]
write.csv(wilke,"~/\\data\\processed\\FileName.csv", row.names = FALSE)

write.csv(shipments,".\\data\\test2.csv", row.names = FALSE)
wilke2 <- read.csv(".\\data\\test2.csv")


write.csv2(wilke, file ="C:\\filename.csv",row.names=FALSE)
write.csv2(wilke, file ="C:\\Users\\Peter\\Documents\\TUB Master\\1. Semester\\SCA\\Case study\\data\\processed\\test.csv",row.names=FALSE)

write.csv2(shipments, file =".\\data\\processed\\shipments_processed.csv",row.names=FALSE)

write.csv2(shipments, file =".\\data\\shipments_processed.csv",row.names=FALSE)

wilke2 <- read.csv(".\\data\\shipments_processed.csv")

wilke3 <- read.csv("data/shipments_processed.csv")

#TODO Erzeugung Datum von Zeile und first_stop_req liegen weit auseinander